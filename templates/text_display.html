{% extends "base.html" %}

{% block title %}Text Extraction - AI Emblematic{% endblock %}

{% set file_hash = file_hash %}

{% block content %}
<style>
    .text-display-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header-info {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .file-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .file-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0d1846;
    }
    
    .timestamp {
        color: #666;
        font-size: 0.9rem;
    }
    
    .text-content {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .text-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #0079c8;
        cursor: pointer;
        user-select: none;
    }
    
    .text-header:hover {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin: -10px -10px 20px -10px;
    }
    
    .minimize-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #0079c8;
        cursor: pointer;
        padding: 5px;
        border-radius: 3px;
        transition: all 0.2s ease;
    }
    
    .minimize-btn:hover {
        background-color: #e9ecef;
        transform: scale(1.1);
    }
    
    .extracted-text {
        line-height: 1.6;
        font-size: 1rem;
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 20px;
        background-color: #fafafa;
        transition: all 0.3s ease;
    }
    
    .extracted-text.minimized {
        max-height: 0;
        padding: 0 20px;
        border: none;
        overflow: hidden;
    }
    
    .text-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #0d1846;
    }
    
    .text-stats {
        color: #666;
        font-size: 0.9rem;
    }
    
    .extracted-text {
        line-height: 1.6;
        font-size: 1rem;
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 20px;
        background-color: #fafafa;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background-color: #0079c8;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #005fa3;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #545b62;
        transform: translateY(-2px);
    }
    
    .copy-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    .copy-btn:hover {
        background-color: #218838;
    }
    
    .copy-success {
        background-color: #28a745 !important;
    }
    
    .summarise-btn {
        background-color: #0079c8;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        margin: 0 15px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .summarise-btn:hover {
        background-color: #005fa3;
        transform: translateY(-2px);
    }
    
    .summarise-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .fhir-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        margin: 0 15px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .fhir-btn:hover {
        background-color: #218838;
        transform: translateY(-2px);
    }
    
    .fhir-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .analysis-section {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .analysis-header {
        border-bottom: 2px solid #0079c8;
        padding-bottom: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }
    
    .analysis-header:hover {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin: -10px -10px 20px -10px;
    }
    
    .analysis-header h3 {
        color: #0d1846;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .analysis-content {
        line-height: 1.6;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .analysis-content.minimized {
        max-height: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }
    
    .analysis-item {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #0079c8;
    }
    
    .analysis-item h4 {
        color: #0d1846;
        margin-top: 0;
        margin-bottom: 10px;
    }
    
    .analysis-item ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .analysis-item li {
        margin-bottom: 5px;
    }
    
    .confidence-badge {
        display: inline-block;
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .groundedness-score {
        font-size: 1.1rem;
        font-weight: 700;
        padding: 4px 12px;
        border-radius: 15px;
        color: white;
    }
    
    .score-5 { background-color: #28a745; }
    .score-4 { background-color: #20c997; }
    .score-3 { background-color: #ffc107; color: #212529; }
    .score-2 { background-color: #fd7e14; }
    .score-1 { background-color: #dc3545; }
    
    .document-type-badge {
        display: inline-block;
        background-color: #0079c8;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    @media (max-width: 768px) {
        .file-info {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .btn {
            width: 100%;
            max-width: 300px;
        }
    }
</style>

<div class="text-display-container">
    <div class="header-info">
        <div class="file-info">
            <div class="file-name">üìÑ {{ data.filename }}</div>
            <div class="timestamp">Processed: {{ data.timestamp[:19].replace('T', ' ') }}</div>
        </div>
    </div>
    
    <div class="text-content">
        <div class="text-header" onclick="toggleMinimize()">
            <div class="text-title">Extracted Text</div>
            <div class="text-stats">
                {{ data.text|length }} characters
                <button class="copy-btn" onclick="copyToClipboard()">Copy Text</button>
                <button class="minimize-btn" id="minimizeBtn">‚àí</button>
            </div>
        </div>
        
        <div class="extracted-text" id="extractedText">{{ data.text }}</div>
    </div>
    
    <!-- AI Summary Results Section -->
    <div class="analysis-section" id="analysisSection" style="display: none;">
        <div class="analysis-header" onclick="toggleAnalysisMinimize()">
            <h3>ü§ñ AI Summary</h3>
            <button class="minimize-btn" id="analysisMinimizeBtn">‚àí</button>
        </div>
        <div class="analysis-content" id="analysisContent">
            <!-- Analysis results will be populated here -->
        </div>
    </div>
    
    <!-- FHIR Conversion Results Section -->
    <div class="analysis-section" id="fhirSection" style="display: none;">
        <div class="analysis-header" onclick="toggleFhirMinimize()">
            <h3>üè• FHIR Conversion</h3>
            <button class="minimize-btn" id="fhirMinimizeBtn">‚àí</button>
        </div>
        <div class="analysis-content" id="fhirContent">
            <!-- FHIR results will be populated here -->
        </div>
    </div>
    
    <div class="action-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-primary">Upload Another Document</a>
        <button class="summarise-btn" onclick="summariseDocument()" id="summariseBtn">
            ü§ñ Summarise
        </button>
        <button class="fhir-btn" onclick="convertToFHIR()" id="fhirBtn">
            üè• Convert to FHIR
        </button>
        <a href="{{ url_for('about') }}" class="btn btn-secondary">Learn More</a>
    </div>
</div>

<script>
function copyToClipboard() {
    const textElement = document.getElementById('extractedText');
    const text = textElement.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
        const copyBtn = document.querySelector('.copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'Copied!';
        copyBtn.classList.add('copy-success');
        
        setTimeout(function() {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('copy-success');
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy text to clipboard');
    });
}

function toggleMinimize() {
    const textElement = document.getElementById('extractedText');
    const minimizeBtn = document.getElementById('minimizeBtn');
    
    if (textElement.classList.contains('minimized')) {
        // Expand
        textElement.classList.remove('minimized');
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize';
    } else {
        // Minimize
        textElement.classList.add('minimized');
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand';
    }
}

function toggleAnalysisMinimize() {
    const analysisContent = document.getElementById('analysisContent');
    const analysisMinimizeBtn = document.getElementById('analysisMinimizeBtn');
    
    if (analysisContent.classList.contains('minimized')) {
        // Expand
        analysisContent.classList.remove('minimized');
        analysisMinimizeBtn.textContent = '‚àí';
        analysisMinimizeBtn.title = 'Minimize';
    } else {
        // Minimize
        analysisContent.classList.add('minimized');
        analysisMinimizeBtn.textContent = '+';
        analysisMinimizeBtn.title = 'Expand';
    }
}

function toggleFhirMinimize() {
    const fhirContent = document.getElementById('fhirContent');
    const fhirMinimizeBtn = document.getElementById('fhirMinimizeBtn');
    
    if (fhirContent.classList.contains('minimized')) {
        // Expand
        fhirContent.classList.remove('minimized');
        fhirMinimizeBtn.textContent = '‚àí';
        fhirMinimizeBtn.title = 'Minimize';
    } else {
        // Minimize
        fhirContent.classList.add('minimized');
        fhirMinimizeBtn.textContent = '+';
        fhirMinimizeBtn.title = 'Expand';
    }
}

function summariseDocument() {
    const summariseBtn = document.getElementById('summariseBtn');
    const analysisSection = document.getElementById('analysisSection');
    const analysisContent = document.getElementById('analysisContent');
    
    // Get the file hash from the URL
    const pathParts = window.location.pathname.split('/');
    const fileHash = pathParts[pathParts.length - 1];
    
    // Disable button and show loading state
    summariseBtn.disabled = true;
    summariseBtn.textContent = 'ü§ñ Analyzing...';
    
    // Show analysis section with loading message
    analysisSection.style.display = 'block';
    analysisContent.innerHTML = '<div class="analysis-item"><h4>Processing...</h4><p>AI is analyzing your document. This may take a few moments.</p></div>';
    
    // Scroll to analysis section
    analysisSection.scrollIntoView({ behavior: 'smooth' });
    
    // Make API call
    fetch(`/summarise/${fileHash}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Display the analysis results
        displayAnalysisResults(data);
        
        // Re-enable button
        summariseBtn.disabled = false;
        summariseBtn.textContent = 'ü§ñ Summarise';
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show error message
        analysisContent.innerHTML = `
            <div class="analysis-item" style="border-left-color: #dc3545;">
                <h4>Error</h4>
                <p>Failed to analyze document: ${error.message}</p>
                <p>Please make sure your Azure OpenAI credentials are configured correctly.</p>
            </div>
        `;
        
        // Re-enable button
        summariseBtn.disabled = false;
        summariseBtn.textContent = 'ü§ñ Summarise';
    });
}

function displayAnalysisResults(data) {
    const analysisContent = document.getElementById('analysisContent');
    
    if (data.is_medical === false) {
        // Display freeform analysis for non-medical documents
        let html = `
            <div class="analysis-item">
                <h4>üìã Document Analysis</h4>
                <div style="white-space: pre-line; font-family: monospace; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0079c8;">
                    ${data.freeform_analysis}
                </div>
            </div>
        `;
        analysisContent.innerHTML = html;
        return;
    }
    
    // Display structured analysis for medical documents
    const classification = data.classification;
    const summary = data.summary;
    
    let html = `
        <div class="analysis-item">
            <h4>üìã Document Classification</h4>
            <p><strong>Type:</strong> <span class="document-type-badge">${classification.document_type}</span></p>
            <p><strong>Confidence:</strong> <span class="confidence-badge">${Math.round(classification.confidence * 100)}%</span></p>
            <p><strong>Language:</strong> ${classification.language}</p>
            <p><strong>Structured:</strong> ${classification.is_structured ? 'Yes' : 'No'}</p>
            <p><strong>Keywords:</strong> ${classification.keywords.join(', ')}</p>
        </div>
        
        <div class="analysis-item">
            <h4>üìù Document Summary</h4>
            <p><strong>Main Topic:</strong> ${summary.main_topic}</p>
            <p><strong>Summary:</strong> ${summary.summary}</p>
        </div>
        
        <div class="analysis-item">
            <h4>üîë Key Points</h4>
            <ul>
                ${summary.key_points.map(point => `<li>${point}</li>`).join('')}
            </ul>
        </div>
    `;
    
    if (summary.action_items && summary.action_items.length > 0) {
        html += `
            <div class="analysis-item">
                <h4>‚úÖ Action Items</h4>
                <ul>
                    ${summary.action_items.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (summary.important_dates && summary.important_dates.length > 0) {
        html += `
            <div class="analysis-item">
                <h4>üìÖ Important Dates</h4>
                <ul>
                    ${summary.important_dates.map(date => `<li>${date}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (summary.entities && summary.entities.length > 0) {
        html += `
            <div class="analysis-item">
                <h4>üë• Key Entities</h4>
                <ul>
                    ${summary.entities.map(entity => `<li>${entity}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    analysisContent.innerHTML = html;
}

function convertToFHIR() {
    const fhirBtn = document.getElementById('fhirBtn');
    const fhirSection = document.getElementById('fhirSection');
    const fhirContent = document.getElementById('fhirContent');
    
    // Get the file hash from the URL
    const pathParts = window.location.pathname.split('/');
    const fileHash = pathParts[pathParts.length - 1];
    
    // Disable button and show loading state
    fhirBtn.disabled = true;
    fhirBtn.textContent = 'üè• Converting...';
    
    // Show FHIR section with loading message
    fhirSection.style.display = 'block';
    fhirContent.innerHTML = '<div class="analysis-item"><h4>Processing...</h4><p>Converting document to FHIR format and evaluating groundedness. This may take a few moments.</p></div>';
    
    // Scroll to FHIR section
    fhirSection.scrollIntoView({ behavior: 'smooth' });
    
    // For now, let's use the regular fetch API to ensure it works
    // We can add SSE back later once we confirm the basic functionality works
    console.log('Using regular fetch API for FHIR conversion...');
    performRegularFhirConversion(fileHash, fhirContent, fhirBtn);
}

function performRegularFhirConversion(fileHash, fhirContent, fhirBtn) {
    // Show simple running status
    fhirContent.innerHTML = '<div class="analysis-item"><h4>üè• Converting to FHIR...</h4><p>Processing document. This may take a few moments.</p></div>';
    
    // Regular fetch API without SSE
    fetch(`/convert-fhir/${fileHash}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Display the FHIR results
        displayFhirResults(data);
        
        // Re-enable button
        fhirBtn.disabled = false;
        fhirBtn.textContent = 'üè• Convert to FHIR';
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show error message
        fhirContent.innerHTML = `
            <div class="analysis-item" style="border-left-color: #dc3545;">
                <h4>Error</h4>
                <p>Failed to convert to FHIR: ${error.message}</p>
                <p>Please make sure your Azure OpenAI credentials are configured correctly.</p>
                <a href="/fhir-logs/${fileHash}" class="btn btn-secondary" target="_blank">View Detailed Logs</a>
            </div>
        `;
        
        // Re-enable button
        fhirBtn.disabled = false;
        fhirBtn.textContent = 'üè• Convert to FHIR';
    });
}

function handleFhirUpdate(data, fhirContent, fhirBtn, eventSource) {
    const status = data.status;
    
    switch (status) {
        case 'starting':
            fhirContent.innerHTML = '<div class="analysis-item"><h4>üöÄ Starting...</h4><p>Initializing FHIR conversion...</p></div>';
            break;
            
        case 'attempt':
            fhirContent.innerHTML = `
                <div class="analysis-item">
                    <h4>üîÑ Attempt ${data.attempt}</h4>
                    <p>${data.message}</p>
                </div>
            `;
            break;
            
        case 'validating':
            fhirContent.innerHTML = `
                <div class="analysis-item">
                    <h4>üîç Validating Structure</h4>
                    <p>${data.message}</p>
                </div>
            `;
            break;
            
        case 'evaluating':
            fhirContent.innerHTML = `
                <div class="analysis-item">
                    <h4>üéØ Evaluating Quality</h4>
                    <p>${data.message}</p>
                </div>
            `;
            break;
            
        case 'groundedness_result':
            const scoreColor = data.score >= 5 ? '#28a745' : data.score >= 3 ? '#ffc107' : '#dc3545';
            const acceptableText = data.is_acceptable ? '‚úÖ Acceptable' : '‚ùå Not Acceptable';
            const acceptableColor = data.is_acceptable ? '#28a745' : '#dc3545';
            
            let groundednessHtml = `
                <div class="analysis-item">
                    <h4>üìä Quality Assessment - Attempt ${data.attempt || 'Current'}</h4>
                    <p><strong>Groundedness Score:</strong> <span class="confidence-badge" style="background-color: ${scoreColor};">${data.score}/5</span></p>
                    <p><strong>Acceptable Quality:</strong> <span style="color: ${acceptableColor}; font-weight: bold;">${acceptableText}</span></p>
                    <p><strong>Assessment:</strong> ${data.assessment}</p>
            `;
            
            if (data.feedback) {
                groundednessHtml += `<p><strong>Improvement Feedback:</strong> ${data.feedback}</p>`;
            }
            
            if (data.priority_fixes && data.priority_fixes.length > 0) {
                groundednessHtml += `
                    <p><strong>Priority Fixes Needed:</strong></p>
                    <ul>
                        ${data.priority_fixes.map(fix => `<li>${fix}</li>`).join('')}
                    </ul>
                `;
            }
            
            if (data.hallucinations && data.hallucinations.length > 0) {
                groundednessHtml += `
                    <p><strong>‚ö†Ô∏è Hallucinations Detected:</strong></p>
                    <ul>
                        ${data.hallucinations.map(h => `<li>${h}</li>`).join('')}
                    </ul>
                `;
            }
            
            if (data.missing_info && data.missing_info.length > 0) {
                groundednessHtml += `
                    <p><strong>üìù Missing Information:</strong></p>
                    <ul>
                        ${data.missing_info.map(m => `<li>${m}</li>`).join('')}
                    </ul>
                `;
            }
            
            if (data.accuracy_issues && data.accuracy_issues.length > 0) {
                groundednessHtml += `
                    <p><strong>üîç Accuracy Issues:</strong></p>
                    <ul>
                        ${data.accuracy_issues.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                `;
            }
            
            groundednessHtml += `</div>`;
            fhirContent.innerHTML = groundednessHtml;
            break;
            
        case 'retry':
            fhirContent.innerHTML = `
                <div class="analysis-item" style="border-left-color: #ffc107;">
                    <h4>üîÑ Retrying with Feedback</h4>
                    <p>${data.message}</p>
                    <p><strong>Attempt:</strong> ${data.attempt || 'Current'} / ${data.max_attempts || 3}</p>
                    <p><strong>Next Attempt:</strong> ${data.next_attempt || 'In Progress'}</p>
                    ${data.feedback ? `<p><strong>Improvement Focus:</strong> ${data.feedback}</p>` : ''}
                </div>
            `;
            break;
            
        case 'success':
            displayFhirResults(data.result);
            fhirBtn.disabled = false;
            fhirBtn.textContent = 'üè• Convert to FHIR';
            eventSource.close();
            break;
            
        case 'failed':
        case 'error':
            fhirContent.innerHTML = `
                <div class="analysis-item" style="border-left-color: #dc3545;">
                    <h4>‚ùå ${status === 'failed' ? 'Conversion Failed' : 'Error'}</h4>
                    <p>${data.message}</p>
                    ${data.result ? `<p><strong>Final Result:</strong> ${JSON.stringify(data.result, null, 2)}</p>` : ''}
                </div>
            `;
            fhirBtn.disabled = false;
            fhirBtn.textContent = 'üè• Convert to FHIR';
            eventSource.close();
            break;
            
        case 'structure_error':
            fhirContent.innerHTML = `
                <div class="analysis-item" style="border-left-color: #dc3545;">
                    <h4>‚ùå Structure Validation Failed</h4>
                    <p>${data.message}</p>
                    <p><strong>Errors:</strong></p>
                    <ul>
                        ${data.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            `;
            break;
            
        default:
            console.log('Unknown status:', status, data);
    }
}

function displayFhirResults(data) {
    const fhirContent = document.getElementById('fhirContent');
    
    if (data.error) {
        let html = `
            <div class="analysis-item" style="border-left-color: #dc3545;">
                <h4>‚ùå Conversion Failed</h4>
                <p><strong>Error:</strong> ${data.error}</p>
        `;
        
        if (data.validation) {
            html += `
                <h5>Validation Results:</h5>
                <p><strong>Validation Score:</strong> ${data.validation.validation_score}%</p>
                <p><strong>Errors:</strong></p>
                <ul>
                    ${data.validation.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
            
            if (data.validation.warnings && data.validation.warnings.length > 0) {
                html += `
                    <p><strong>Warnings:</strong></p>
                    <ul>
                        ${data.validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                `;
            }
        }
        
        if (data.groundedness) {
            html += `
                <h5>Groundedness Evaluation:</h5>
                <p><strong>Groundedness Score:</strong> ${data.groundedness.groundedness_score}/5</p>
                <p><strong>Assessment:</strong> ${data.groundedness.overall_assessment}</p>
            `;
            
            if (data.groundedness.hallucinations_detected && data.groundedness.hallucinations_detected.length > 0) {
                html += `
                    <p><strong>Hallucinations Detected:</strong></p>
                    <ul>
                        ${data.groundedness.hallucinations_detected.map(h => `<li>${h}</li>`).join('')}
                    </ul>
                `;
            }
        }
        
        if (data.feedback_history && data.feedback_history.length > 0) {
            html += `
                <h5>Learning History:</h5>
                <p>This conversion was improved through ${data.feedback_history.length} feedback iterations:</p>
                <ul>
                    ${data.feedback_history.map((feedback, index) => `
                        <li>
                            <strong>Attempt ${index + 1}:</strong> Score ${feedback.groundedness_score}/5
                            ${feedback.improvement_feedback ? `<br/>‚Üí ${feedback.improvement_feedback}` : ''}
                        </li>
                    `).join('')}
                </ul>
            `;
        }
        
        // Add link to detailed logs for errors
        const pathParts = window.location.pathname.split('/');
        const fileHash = pathParts[pathParts.length - 1];
        html += `
            <div style="margin-top: 15px;">
                <a href="/fhir-logs/${fileHash}" class="btn btn-secondary" target="_blank">View Detailed Logs</a>
            </div>
        `;
        
        html += `</div>`;
        fhirContent.innerHTML = html;
        return;
    }
    
    const validation = data.validation;
    const fhirBundle = data.fhir_bundle;
    const groundedness = data.groundedness;
    
    // Determine success status based on groundedness score
    const isHighQuality = groundedness && groundedness.groundedness_score >= 5;
    const statusIcon = isHighQuality ? '‚úÖ' : '‚ö†Ô∏è';
    const statusText = isHighQuality ? 'FHIR Conversion Successful' : 'FHIR Conversion Completed (Quality Issues)';
    
    let html = `
        <div class="analysis-item">
            <h4>${statusIcon} ${statusText}</h4>
            <p><strong>Validation Score:</strong> <span class="confidence-badge">${validation.validation_score}%</span></p>
            <p><strong>Resource Count:</strong> ${validation.resource_count}</p>
            <p><strong>Resource Types:</strong> ${validation.resource_types.join(', ')}</p>
            <p><strong>Status:</strong> ${validation.is_valid ? 'Valid FHIR Bundle' : 'Invalid FHIR Bundle'}</p>
        </div>
    `;
    
    // Add groundedness evaluation results
    if (groundedness) {
        const scoreColor = groundedness.groundedness_score >= 5 ? '#28a745' : 
                          groundedness.groundedness_score >= 3 ? '#ffc107' : '#dc3545';
        const acceptableText = groundedness.is_acceptable ? '‚úÖ Yes' : '‚ùå No';
        const acceptableColor = groundedness.is_acceptable ? '#28a745' : '#dc3545';
        
        html += `
            <div class="analysis-item">
                <h4>üéØ Groundedness Evaluation</h4>
                <p><strong>Groundedness Score:</strong> <span class="confidence-badge" style="background-color: ${scoreColor};">${groundedness.groundedness_score}/5</span></p>
                <p><strong>Assessment:</strong> ${groundedness.overall_assessment}</p>
                <p><strong>Acceptable Quality:</strong> <span style="color: ${acceptableColor}; font-weight: bold;">${acceptableText}</span></p>
        `;
        
        if (groundedness.hallucinations_detected && groundedness.hallucinations_detected.length > 0) {
            html += `
                <p><strong>‚ö†Ô∏è Hallucinations Detected:</strong></p>
                <ul>
                    ${groundedness.hallucinations_detected.map(h => `<li>${h}</li>`).join('')}
                </ul>
            `;
        }
        
        if (groundedness.missing_information && groundedness.missing_information.length > 0) {
            html += `
                <p><strong>üìù Missing Information:</strong></p>
                <ul>
                    ${groundedness.missing_information.map(m => `<li>${m}</li>`).join('')}
                </ul>
            `;
        }
        
        if (groundedness.accuracy_issues && groundedness.accuracy_issues.length > 0) {
            html += `
                <p><strong>üîç Accuracy Issues:</strong></p>
                <ul>
                    ${groundedness.accuracy_issues.map(a => `<li>${a}</li>`).join('')}
                </ul>
            `;
        }
        
        if (groundedness.improvement_feedback) {
            html += `
                <p><strong>üí° Improvement Feedback:</strong> ${groundedness.improvement_feedback}</p>
            `;
        }
        
        if (groundedness.priority_fixes && groundedness.priority_fixes.length > 0) {
            html += `
                <p><strong>üéØ Priority Fixes:</strong></p>
                <ul>
                    ${groundedness.priority_fixes.map(fix => `<li>${fix}</li>`).join('')}
                </ul>
            `;
        }
        
        html += `</div>`;
    }
    
    // Add link to detailed logs
    if (data.detailed_logs && data.detailed_logs.length > 0) {
        html += `
            <div class="analysis-item">
                <h4>üìã Conversion Logs</h4>
                <p>Detailed logs of all conversion attempts and LLM interactions are available.</p>
                <a href="/fhir-logs/${fileHash}" class="btn btn-secondary" target="_blank">View Detailed Logs</a>
            </div>
        `;
    }
    
    if (validation.warnings && validation.warnings.length > 0) {
        html += `
            <div class="analysis-item">
                <h4>‚ö†Ô∏è Validation Warnings</h4>
                <ul>
                    ${validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    html += `
        <div class="analysis-item">
            <h4>üìã FHIR Bundle</h4>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745; max-height: 400px; overflow-y: auto;">
                <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; margin: 0;">${JSON.stringify(fhirBundle, null, 2)}</pre>
            </div>
            <button class="copy-btn" onclick="copyFhirToClipboard()" style="margin-top: 10px;">Copy FHIR JSON</button>
        </div>
    `;
    
    fhirContent.innerHTML = html;
}

function copyFhirToClipboard() {
    const fhirContent = document.getElementById('fhirContent');
    const preElement = fhirContent.querySelector('pre');
    if (preElement) {
        const fhirText = preElement.textContent;
        
        navigator.clipboard.writeText(fhirText).then(function() {
            const copyBtn = fhirContent.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('copy-success');
            
            setTimeout(function() {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('copy-success');
            }, 2000);
        }).catch(function(err) {
            console.error('Could not copy FHIR text: ', err);
            alert('Failed to copy FHIR JSON to clipboard');
        });
    }
}

// Auto-scroll to top when page loads
window.scrollTo(0, 0);
</script>
{% endblock %}
